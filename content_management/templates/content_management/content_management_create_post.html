{% extends "content_management/content_management_base.html" %}
{% load static %}

{% block body %}	
<style>
</style>

	<div class="row">
		<div class="col-md-12 text-center">
			<h1><u> Add New Post</u></h1><hr>
		</div>
	</div>

	<div class="row">
		<form id="post_form" method="post" action="/create/post/">
			{% csrf_token %}
			{{ form.non_field_errors }}
			<div class="col-md-2 text-center">
				<h3>Select Category</h3>



<select id="main_categories" style="margin-top:10px;"  size="1" class="form-control" >
                <option value="0">Select Category</option>
                {% if categories %}
                {% for category in categories %}
				{% if category.level == 1 %}
                <option value="" data-lt={{ category.lt }} data-rt={{ category.rt }} >{{ category.name }}</option>
				{% endif %}
                {% endfor %}
                {% endif %}
            </select>



<select id="id_category" name="category" style="margin-top:10px;" size="1" class="form-control" disabled>
                <option>Select Sub-Category </option>
            </select>

				{% if form.category.errors %}
					{% for error in form.category.errors %}
						<div class="alert alert-danger">{{error|escape }}</div>
					{% endfor %}
				{% endif %}
			</div>	

		<div class="col-md-8" style="padding:20px 0;">
			<div class="row form-group" >
				<div class="col-md-1 col-sm-1">	
					<label for="{{ form.title.id_for_label }}" class="col-md-2 text-center"> Title:</label>
				</div>
				<div class="col-md-10 col-sm-10">
					<input type="text" name="title" maxlength="70" id="{{ form.title.id_for_label }}" class="form-control" value="{{ form.title.value }}"/>
				</div>
				<div class="col-md-1 col-sm-1">
				</div>
				{% if form.title.errors %}
					{% for error in form.title.errors %}
						<div class="alert alert-danger">{{ error|escape }}</div>	
					{% endfor %}
				{% endif %}
			</div>	

			<div class="row form-group">
				<div class="col-md-1 col-sm-1">
					<label for="{{ form.post_name.id_for_label }}" class="col-md-2"> Post Name:</label>
				</div>
				<div class="col-md-10 col-sm-10">
					<input type="text" name="post_name" maxlength="100" id="{{ form.post_name.id_for_label }}" class="form-control" value="{{ form.post_name.value }}"/>
				</div>
				<div class="col-md-1 col-sm-1">
				</div>
				{% if form.post_name.errors %}
					{% for error in form.post_name.errors %}
						<div class="alert alert-danger">{{error|escape }}</div>
					{% endfor %}
				{% endif %}
			</div>

			<textarea name="content" id="{{ form.content.id_for_label }}">
			{{ form.content.value }}k
			</textarea>
			<script src="http://cdn.ckeditor.com/4.4.3/full/ckeditor.js"></script>
			<script>
				// Replace the <textarea id="editor1"> with a CKEditor instance, using default configuration.
				CKEDITOR.replace('content');
			</script>
			{% if form.content.errors %}
             	{% for error in form.content.errors %}
                   	<div class="alert alert-danger">{{error|escape }}</div>
                {% endfor %}
            {% endif %}

		
			<div class="row ">
				<div class="col-md-6">
					<label for="{{ form.metadata.id_for_label }}" class="col-md-2"> Metadata:</label>
					<input type="text" name="metadata" maxlength="140" id="{{ form.metadata.id_for_label }}" class="form-control" value="{{ form.metadata.value }}"/>
				 {% if form.metadata.errors %}
                 	{% for error in form.metadata.errors %}
                    	<div class="alert alert-danger">{{error|escape }}</div>
                    {% endfor %}
                 {% endif %}
				</div>


				<div class="col-md-6">
					<label for="{{ form.excerpt.id_for_label }}" class="col-md-2"> Excerpt:</label>
					<input type="text" name="excerpt" maxlength="500" id="{{ form.excerpt.id_for_label }}" class="form-control" value="{{ form.excerpt.value }}"/>
					{% if form.excerpt.errors %}
                    	{% for error in form.excerpt.errors %}
                        	<div class="alert alert-danger">{{error|escape }}</div>
                    	{% endfor %}
					{% endif %}
				</div>
			</div>
		</div>
		<div class="col-md-2 text-center" style="padding-top:10px;">
			<div><input type="submit" value="Publish" name="publish" class="btn btn-lg btn-success"/></div><br>	
			<div><input type="submit" value="Save as Draft" name="draft" class="btn btn-lg btn-primary"/></div><br>
			{% if request.user.is_staff %}
			<div><input type="submit" value="Publish and Create Another" name="publishandcreate" class="btn btn-lg btn-success"/></div><br>	
			{% endif %}
		</div>
		</form>
	</div>		

<div id="dropbox" class="container" style="height:250px; border:2px dashed red;">
<h1>"Only [dot] and alphanumeric characters are allowed in file name. No spaces are allowed in filename."</h1>
</div>


    <div id="progress-bar" class="progress">
        <div class="progress-bar"></div>
    </div>






{% endblock %}
{% block scripts %}

<script type="text/javascript"> 
//Ajax to load leaf categories on selecting main category
$("#main_categories").change(function(){var selected=$("#main_categories :selected");$.get('/updateleafcategory/',{"category_lt":selected.data("lt"), "category_rt":selected.data("rt")} , function(data){$("#id_category").html(data); $('#id_category').prop("disabled", false);console.log(data);});})


//Code for Image upload

// Custom jQuery xhr instance to support our progress bar.

var xhr_with_progress = function() {
     var xhr = new XMLHttpRequest();
     xhr.upload.addEventListener("progress",
         function(evt) {
             if (!evt.lengthComputable) return;
             var percentComplete = evt.loaded / evt.total;
             $("#progress-bar div.progress-bar").css('width', String(100*percentComplete) + "%");
         }, false);
     return xhr;
 };





$.support.cors = true;//For cross origin transfer

//Event listners to avoid default drag and drop reaction of browser
window.addEventListener("dragover",function(e){
  e = e || event;
  e.preventDefault();
},false);
window.addEventListener("drop",function(e){
  e = e || event;
  e.preventDefault();
},false);


//Event listners to listen drag and drop image in box
var dropbox = document.getElementById("dropbox"); 
dropbox.addEventListener("dragover",function(e){
  e = e || event;
  e.preventDefault();
  $('#dropbox').css("background-color","gray");
},false);

window.addEventListener("dragleave",function(e){
  e = e || event;
  e.preventDefault();
  $('#dropbox').css("background-color","white"); 
},false);


dropbox.addEventListener("drop",drop,false);
function drop(evt){
$('#dropbox').css("background-color","white"); 
alert("detected");
evt.stopPropagation();
evt.preventDefault();
 
var files = evt.dataTransfer.files;
var count = files.length;
	if(count>0){
		for(var i=0;i<count;i++){
handleFiles(files[i]);
}
}
}

function handleFiles(file){

			var filename = file.name;
			$.ajax({
				type:'GET',
				data:{"filename":file.name},
				url:'/generateuploadurl/',
				contentType:"application/json",
				dataType:"json",
				success: function(data){ 
					if(data.UploadUrl){
					/*	console.log("upload url successfully created for " + file.name + " file");*/
						console.log(data.UploadUrl);
						handleUpload(data.UploadUrl, file);
					}
				},
				error: function(data){ 
					console.log("error occured while creating upload url for " + file.name + ' file');
					console.log(data);
					
				},
			});
		}			
	

function handleUpload(UploadUrl, file){
	$.ajax({
		xhr:xhr_with_progress,
		url:UploadUrl,
		type:'PUT',
		data:file,
		cache:false,
		contentType:false,
		processData:false,
		success: function(data){
			image="<img style=width:100% src=https://d77da31580fbc8944c00-52b01ccbcfe56047120eec75d9cb2cbd.ssl.cf6.rackcdn.com/" + file.name + ">";
			console.log(image);
			$('iframe').contents().find('body.cke_editable').contents().append(image);
			
			console.log( file.name + " successfully uploaded");
		},
		error: function(data){ 
			console.log("error occured while uploading " + file.name );
			console.log(data);
		}
	});	
}

</script>


{% endblock %}
